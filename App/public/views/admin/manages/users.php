<div class="space-y-4 w-full">

    <div class="w-full grid grid-cols-2 md:grid-cols-3 lg:grid-cols-3 xl:grid-cols-5 gap-2">

        <div class="bg-white rounded-lg shadow p-6 col-span-2 md:col-span-3 xl:col-span-1">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">ผู้ใช้ทั้งหมด</p>
                    <p class="text-2xl font-bold text-gray-900">500</p>
                </div>
                <div class="p-3 bg-green-100 rounded-full text-emerald-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24">
                        <path fill="currentColor"
                            d="M5.85 17.1q1.275-.975 2.85-1.537T12 15t3.3.563t2.85 1.537q.875-1.025 1.363-2.325T20 12q0-3.325-2.337-5.663T12 4T6.337 6.338T4 12q0 1.475.488 2.775T5.85 17.1M12 13q-1.475 0-2.488-1.012T8.5 9.5t1.013-2.488T12 6t2.488 1.013T15.5 9.5t-1.012 2.488T12 13m0 9q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22"
                            stroke-width="0.5" stroke="currentColor" />
                    </svg>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6 md:col-span-3 xl:col-span-1">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">ผู้ใช้ทั่วไป</p>
                    <p class="text-2xl font-bold text-gray-900">16</p>
                </div>
                <div class="p-3 bg-orange-100 rounded-full text-orange-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24">
                        <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                            stroke-width="2">
                            <circle cx="12" cy="8" r="5" />
                            <path d="M20 21a8 8 0 0 0-16 0" />
                        </g>
                    </svg>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">ผู้ดูแลระบบ</p>
                    <p class="text-2xl font-bold text-gray-900">5</p>
                </div>
                <div class="p-3 bg-blue-100 rounded-full text-sky-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24">
                        <path fill="currentColor"
                            d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12c5.16-1.26 9-6.45 9-12V5zm0 2.18l7 3.12v4.92c0 1.7-.5 3.43-1.35 4.95C16 14.94 13.26 14.5 12 14.5s-4 .44-5.65 1.67C5.5 14.65 5 12.92 5 11.22V6.3zM12 6a3.5 3.5 0 0 0-3.5 3.5A3.5 3.5 0 0 0 12 13a3.5 3.5 0 0 0 3.5-3.5A3.5 3.5 0 0 0 12 6m0 2a1.5 1.5 0 0 1 1.5 1.5A1.5 1.5 0 0 1 12 11a1.5 1.5 0 0 1-1.5-1.5A1.5 1.5 0 0 1 12 8m0 8.5c1.57 0 3.64.61 4.53 1.34C15.29 19.38 13.7 20.55 12 21c-1.7-.45-3.29-1.62-4.53-3.16c.9-.73 2.96-1.34 4.53-1.34"
                            stroke-width="0.5" stroke="currentColor" />
                    </svg>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">เจ้าหน้าที่คณะ</p>
                    <p class="text-2xl font-bold text-gray-900">32</p>
                </div>
                <div class="p-3 bg-purple-100 rounded-full text-purple-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 48 48">
                        <g fill="currentColor" stroke-width="0.5" stroke="currentColor">
                            <path fill-rule="evenodd"
                                d="M20.5 14a4 4 0 1 0 0-8a4 4 0 0 0 0 8m0-2a2 2 0 1 0 0-4a2 2 0 0 0 0 4"
                                clip-rule="evenodd" />
                            <path d="M27 22a2 2 0 0 0-2-2v4a2 2 0 0 0 2-2" />
                            <path fill-rule="evenodd"
                                d="M11 35a3 3 0 0 0-2-2.83V22h5v17a3 3 0 1 0 6 0v-8h1v8c0 .701.24 1.346.644 1.857A3 3 0 0 0 27 39V27.718c1.563-.72 4-2.808 4-6.147C31 17.364 27.129 16 26.015 16H9v-3H7v3.764c-.614.55-1 1.348-1 2.236s.386 1.687 1 2.236v10.935A3 3 0 0 0 5 35v6h2v-4h2v4h2zm14-8.563l1.163-.536c1.144-.527 2.837-2.047 2.837-4.33c0-1.394-.605-2.238-1.308-2.789a4.3 4.3 0 0 0-1.126-.63a2.7 2.7 0 0 0-.543-.15q-.02-.002-.008-.002H9v2h7v19a1 1 0 1 0 2 0V29h5v10a1 1 0 1 0 2 0zm12.754-8.752a10 10 0 0 1-.754.77v2.485c.395-.39.892-.605 1.33-.73c.445-.126.905-.18 1.3-.2a9 9 0 0 1 1.43.046l.027.003l.009.001h.004c.457.062.814.428.863.887v.013l.004.027a6 6 0 0 1 .026.412c.01.264.013.629-.016 1.031c-.03.398-.093.86-.227 1.306c-.132.437-.354.932-.748 1.322c-.396.392-.893.607-1.331.731c-.446.127-.906.18-1.301.2a9 9 0 0 1-1.338-.035L37 25.951v8.989c.395-.39.892-.605 1.33-.73c.445-.126.905-.18 1.3-.2a9 9 0 0 1 1.43.046l.027.003l.009.001h.004c.457.062.814.428.863.887v.013l.004.027a6 6 0 0 1 .026.412c.01.264.013.629-.016 1.031c-.03.398-.093.86-.227 1.306c-.132.437-.354.932-.748 1.323c-.396.391-.893.606-1.331.73c-.446.127-.906.18-1.301.2a9 9 0 0 1-1.338-.035L37 39.951V41a1 1 0 1 1-2 0v-8.05l-.032.003a9 9 0 0 1-1.338.035a6 6 0 0 1-1.3-.2c-.44-.124-.936-.339-1.331-.73s-.617-.886-.749-1.323a6 6 0 0 1-.227-1.306a9 9 0 0 1 .01-1.443l.003-.027l.001-.009v-.004c.05-.459.406-.825.863-.886h.004l.009-.002l.027-.003l.092-.01q.117-.013.316-.027a9 9 0 0 1 1.022-.008c.395.02.855.073 1.3.2c.439.124.935.338 1.33.729v-9.484a10 10 0 0 1-.754-.771a6.5 6.5 0 0 1-.813-1.147C33.203 16.11 33 15.58 33 15s.202-1.111.433-1.538c.234-.434.534-.826.813-1.147a10 10 0 0 1 1.098-1.07l.022-.018l.007-.006l.003-.002v-.001c.365-.29.883-.29 1.248 0l.003.003l.007.005l.022.019a7 7 0 0 1 .33.287c.208.19.486.46.768.783c.28.32.579.713.813 1.147c.23.427.433.958.433 1.538s-.202 1.111-.433 1.538a6.5 6.5 0 0 1-.813 1.147m-1.508-1.314a7 7 0 0 1-.246.268a7 7 0 0 1-.246-.268a4.5 4.5 0 0 1-.562-.783C35.048 15.32 35 15.124 35 15s.048-.32.192-.588c.141-.26.341-.53.562-.783q.125-.143.246-.268q.12.125.246.268c.22.254.421.523.562.783c.144.268.192.464.192.588s-.048.32-.192.588c-.141.26-.341.53-.562.783m2.629 19.764c-.261.074-.403.162-.47.228s-.16.212-.24.479a4 4 0 0 0-.147.874a7 7 0 0 0-.015.284q.129-.001.265-.008c.306-.016.605-.055.857-.127c.261-.074.404-.162.47-.228c.067-.066.16-.212.24-.479a4 4 0 0 0 .147-.874a7 7 0 0 0 .015-.284q-.129.001-.265.008a4 4 0 0 0-.857.127m-.47-13.772c.067-.066.209-.154.47-.228c.253-.072.552-.111.857-.127q.136-.007.265-.008a7 7 0 0 1-.015.284c-.023.311-.07.617-.147.874c-.08.267-.173.412-.24.479c-.066.066-.209.154-.47.228a4 4 0 0 1-.857.127q-.136.007-.265.008q.005-.138.015-.284c.023-.311.07-.617.147-.874c.08-.267.173-.412.24-.479M32.003 29q.005.138.015.284c.023.311.07.617.147.874c.08.267.173.412.24.479c.067.066.209.154.47.228c.253.072.552.111.857.127q.136.007.265.008a7 7 0 0 0-.015-.284a4 4 0 0 0-.147-.874c-.08-.267-.173-.412-.24-.479c-.066-.066-.209-.154-.47-.228a4 4 0 0 0-.857-.127a6 6 0 0 0-.265-.008"
                                clip-rule="evenodd" />
                        </g>
                    </svg>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">เจ้าหน้าที่จุดฝาก</p>
                    <p class="text-2xl font-bold text-gray-900">16</p>
                </div>
                <div class="p-3 bg-yellow-100 rounded-full text-yellow-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 48 48">
                        <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                            stroke-width="3">
                            <path
                                d="M20.5 36.5c-1.024 0-1.93-.058-2.682-.135c-1.225-.125-1.877-1.392-1.346-2.503C17.74 31.203 19 29 19 29l-4.5 1m7.005-4.804a27 27 0 0 1 1.458-2.255c.72-.998 2.144-.93 2.84.086a84 84 0 0 1 2.947 4.62l1.384-4.397m.361 8.304c.512.886.915 1.701 1.224 2.39c.505 1.123-.267 2.321-1.495 2.417c-2.936.23-5.474.242-5.474.242L27.866 40" />
                            <path
                                d="M6.183 15.842c3.076.249 8.554.522 17.796.522c9.288 0 14.774-.276 17.843-.526c-.888 13.818-1.736 21.005-2.241 24.427c-.255 1.73-1.392 3.14-3.092 3.548C34.173 44.37 30.187 45 24.002 45s-10.171-.63-12.487-1.186c-1.7-.408-2.837-1.818-3.092-3.548c-.505-3.421-1.353-10.608-2.24-24.423Z" />
                            <path
                                d="M31.036 7.176c3.56.066 6.334.174 8.322.275c2.39.12 4.61 1.393 5.278 3.691q.152.517.276 1.097c.394 1.84-.983 3.421-2.858 3.58c-3.02.255-8.547.545-18.077.545c-9.529 0-15.057-.29-18.076-.545c-1.876-.158-3.261-1.75-2.776-3.568c.175-.655.39-1.253.616-1.784c.813-1.903 2.77-2.885 4.836-2.999c1.908-.104 4.685-.222 8.387-.292A7 7 0 0 1 23.37 3h1.262a7 7 0 0 1 6.405 4.176Z" />
                        </g>
                    </svg>
                </div>
            </div>
        </div>

    </div>

    <div x-data="UserTable()" x-init="loadUsers()" class="bg-white rounded-lg shadow p-6 overflow-x-auto w-full">
        <div class="mb-4">
            <h2 class="text-2xl font-bold mb-0">
                จัดการผู้ใช้
                <p class="text-xs font-light">เพิ่ม/ลบ/แก้ไข รายชื่อผู้ใช้</p>
            </h2>
        </div>
        <table class="w-full table-auto border-collapse border border-gray-300 text-xs">
            <thead class="bg-gray-200 text-sm">
                <tr>
                    <th class="border border-gray-300 px-4 py-2">คณะ</th>
                    <th class="border border-gray-300 px-4 py-2">สาขาวิชา</th>
                    <th class="border border-gray-300 px-4 py-2">อีเมลล์</th>
                    <th class="border border-gray-300 px-4 py-2">บทบาท</th>
                    <th class="border border-gray-300 px-4 py-2">ชื่อ</th>
                    <th class="border border-gray-300 px-4 py-2">คะแนน</th>
                </tr>
            </thead>
            <template x-for="user in users" :key="user.account_id">
                <tr class="hover:bg-sky-100 cursor-pointer" @click="selectingRow(user)"
                    :class="selectedUser && selectedUser.account_id == user.account_id ? 'bg-blue-100' : ''">
                    <td class="border border-gray-300 px-4 py-2" x-text="user.account_faculty ?? 'ไม่ระบุ'"></td>
                    <td class="border border-gray-300 px-4 py-2" x-text="user.account_major ?? 'ไม่ระบุ'"></td>
                    <td class="border border-gray-300 px-4 py-2" x-text="user.account_email"></td>
                    <td class="border border-gray-300 px-4 py-2" x-text="user.account_role"></td>
                    <td class="border border-gray-300 px-4 py-2" x-text="user.account_name ?? 'ไม่มีชื่อ'"></td>
                    <td class="border border-gray-300 px-4 py-2" x-text="user.account_score ?? 'ไม่มีคะแนน'"></td>
                </tr>
            </template>
        </table>

        <div class="flex items-center justify-between mt-4 text-sm">

            <button class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50" :disabled="page <= 1"
                @click="page--; loadUsers()">
                ก่อนหน้า
            </button>

            <div class="flex items-center space-x-2">
                <template x-for="p in totalPages">
                    <button class="px-2 py-1 rounded"
                        :class="p === page ? 'bg-blue-500 text-white' : 'bg-gray-200 hover:bg-gray-300'"
                        @click="page = p; loadUsers()" x-text="p">
                    </button>
                </template>
            </div>

            <button class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50"
                :disabled="page >= totalPages" @click="page++; loadUsers()">
                ถัดไป
            </button>

        </div>

        <dialog x-ref="userDialog" x-show="selectedUser"
            x-init="$watch('selectedUser', value => {if (value) $refs.userDialog.showModal();else $refs.userDialog.close();})"
            @click.self="selectedUser = null" class="fixed inset-0 mx-auto my-auto p-0 bg-transparent">

            <div class="bg-white p-6 rounded-lg shadow-xl w-80">
                <h3 class="font-bold text-lg mb-3">แก้ไขข้อมูล</h3>

                <div class="grid grid-1 space-y-2">

                    <div class="flex space-x-2 justify-between">
                        <label for="edit_acc_name">ชื่อ</label>
                        <input class="border border-gray-300 rounded p-1 text-xs" type="text" id="edit_acc_name"
                            x-model="editUserForm.account_name">
                    </div>

                    <div class="flex space-x-2 justify-between">
                        <label for="edit_acc_mail">อีเมลล์</label>
                        <input class="border border-gray-300 rounded p-1 text-xs" type="text" id="edit_acc_mail"
                            x-model="editUserForm.account_email">
                    </div>

                    <div class="flex space-x-2 justify-between">
                        <label for="edit_acc_faculty">คณะ</label>
                        <input class="border border-gray-300 rounded p-1 text-xs" type="text" id="edit_acc_faculty"
                            x-model="editUserForm.faculty_id">
                    </div>

                    <div class="flex space-x-2 justify-between">
                        <label for="edit_acc_major">สาขาวิชา</label>
                        <input class="border border-gray-300 rounded p-1 text-xs" type="text" id="edit_acc_major"
                            x-model="editUserForm.major_id">
                    </div>

                </div>

                <div class="mt-4 text-right">
                    <button @click="submitEdit" class="px-3 py-1 bg-sky-300 rounded hover:bg-sky-400 cursor-pointer">
                        ยืนยัน
                    </button>
                    <button @click="selectedUser = null"
                        class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 cursor-pointer">
                        ยกเลิก
                    </button>
                </div>
            </div>
        </dialog>

    </div>


</div>

<script>

    function UserTable() {
        return {
            users: [],
            selectedUser: null,
            page: 1,
            limit: 10,
            totalPages: 1,
            editUserForm: {
                account_name: '',
                account_email: '',
                faculty_id: '',
                major_id: ''
            },

            async loadUsers() {
                try {
                    this.offset = (this.page - 1) * this.limit;
                    const res = await fetch(`/api/users?page=${this.page}&limit=${this.limit}`);
                    let data = await res.json();
                    this.users = data.result;
                    this.totalPages = Math.ceil(data.total / this.limit);
                    // console.log(this.users);
                } catch (err) {
                    console.error("โหลดข้อมูลล้มเหลว", err);
                }
            },
            selectingRow(user) {
                this.selectedUser = user;

                this.editUserForm = {
                    account_name: user.account_name ?? '',
                    account_email: user.account_email ?? '',
                    faculty_id: user.faculty_id ?? '',
                    major_id: user.major_id ?? '',
                };
                // console.log(this.selectedUser);
            },
            async submitEdit() {
                try {
                    const res = await fetch(`/api/users/${this.selectedUser.account_id}`,
                        {
                            method: 'POST',
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify(this.editUserForm)
                        })
                    const response = await res.json();
                    if (response.success) {
                        this.loadUsers();
                        this.selectedUser = null;
                        this.editUserForm = {
                            account_name: '',
                            account_email: '',
                            faculty_id: '',
                            major_id: '',
                        };
                    }
                    console.log(response);
                } catch (error) {
                    console.error(error);
                }
            },
        }

    }
</script>